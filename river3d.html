<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My first three.js app</title>
    <style>
        body {
            margin: 0;
        }

        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
        }
    </style>
</head>
<div id="info">Description</div>

<body>
    <script src="js/three.js"></script>
    <script>
        // Our Javascript will go here.
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xa0a0a0);
        scene.fog = new THREE.Fog(0xa0a0a0, 10, 50);
        // const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 500);

        // camera.position.set(23922, -57096, -10);
        // camera.lookAt(24652, -59236, 0);
        camera.position.set(5, 5, -10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        // const geometry = new THREE.BoxGeometry();
        const river_array_raw = [[116.26384246146783, 40.003631891420106], [116.26384246146783, 40.00324314379673], [116.26384246146783, 40.00274641072241], [116.26387159672376, 40.002076900926596], [116.26395900249156, 40.00158016785228], [116.26398813774749, 40.00116982313872], [116.26398813774749, 40.00082426969571], [116.26407554351529, 40.000629895884025], [116.26433776081866, 40.00024114826064], [116.26451257235426, 39.999873997727455], [116.26451257235426, 39.999852400637266], [116.26454170761019, 39.99942045883351], [116.26465824863392, 39.99872935194751], [116.26534383762798, 39.99717787485711], [116.2660835999886, 39.99587023853187], [116.26665264795831, 39.99452042038969], [116.26756312470985, 39.99270660226114], [116.26824598227351, 39.99127242048507], [116.2690426494311, 39.990428784146204], [116.26972550699476, 39.98958514780734], [116.2704083645584, 39.988910238736246], [116.27097741252813, 39.9882775114821], [116.27148053109902, 39.9876942693801], [116.27188329685845, 39.98718561473543], [116.27233081436894, 39.986500036736096], [116.27283435583219, 39.98575827390578], [116.27327721170934, 39.985291776771426], [116.27376668399462, 39.984617947577355], [116.27430277268802, 39.98401322906986], [116.27469901215706, 39.98352945426386], [116.27525840905452, 39.98294201342801], [116.27560803211543, 39.98251007163694], [116.27600427158445, 39.98195718614437], [116.27637720284943, 39.981456133666725], [116.27684336693065, 39.98069591611445], [116.2772862228078, 39.98005664226366], [116.2774027638281, 39.97971108883081], [116.27761253766465, 39.97936553539795], [116.27791750161896, 39.978662282378345], [116.27838339718001, 39.97785834265798], [116.27868126483378, 39.97736578804058], [116.27898677011972, 39.97700911055902], [116.27962660832404, 39.97637093784877], [116.2803724708188, 39.97562799800317], [116.2811649497195, 39.974885058157575], [116.28188750401131, 39.97417667365363], [116.2823769762735, 39.97364106585796], [116.2827965239268, 39.97322640175809], [116.28302960595641, 39.97300179203733], [116.28347246181268, 39.97260440560829], [116.28363561923342, 39.9723625182167], [116.28379877665415, 39.97208607548345], [116.28410178329264, 39.97168868905441], [116.28438148172819, 39.97125674728371], [116.28463742516236, 39.970559662921794], [116.28475396618609, 39.969890153125974], [116.28498704823355, 39.96935022587129], [116.28542407707252, 39.96835675972265], [116.28586110591148, 39.96762245865627], [116.28623753341152, 39.967030521600456], [116.28647993873683, 39.9667126124382], [116.28666640437167, 39.9664638139634], [116.28702068907788, 39.966090616251186], [116.28733768065712, 39.9658279956389], [116.28765467223637, 39.9655653750266], [116.28800895694258, 39.9651783551769], [116.28838188821227, 39.96463929181482], [116.28877346604546, 39.96410022845274], [116.28908342063754, 39.96355532607734], [116.28925823218137, 39.96318817552684], [116.2894330437252, 39.96275623370271], [116.28960785526904, 39.96215151514894], [116.28969526104095, 39.961546796595165], [116.28978266681287, 39.96105006349742], [116.2898992078421, 39.96061812167329], [116.29019056041514, 39.95999180602831], [116.29039450721629, 39.95953826711298], [116.29071499504664, 39.95904153401524], [116.29106461813431, 39.95876077182956], [116.29141424122199, 39.958501606735084], [116.29170559379504, 39.95824244164061], [116.29223002842654, 39.95798327654614], [116.29255051625691, 39.957702514360456], [116.29292927460187, 39.957292169627536], [116.2935452122088, 39.95641274414368], [116.29398806810684, 39.9557907479352], [116.29440761579973, 39.95511691870935], [116.29492039631324, 39.95446036715596], [116.29527001939066, 39.95373470491274], [116.29557302605772, 39.95326820775639], [116.2958760327248, 39.9529744873246], [116.29631888862285, 39.952611656203], [116.2965286624693, 39.952404324133504], [116.29692490195701, 39.952179714391555], [116.29748429888086, 39.95193782697715], [116.29802038759954, 39.951799605597486], [116.2988976322166, 39.95167999325554], [116.29956774310301, 39.95150721653404], [116.30050007129282, 39.951096871820475], [116.30134499371484, 39.95051375038541], [116.3020442398572, 39.94995222604053], [116.30286002702327, 39.94932591042509], [116.30379235521309, 39.948634803539086], [116.30457900712324, 39.947986890833455], [116.3052782532656, 39.94753335193951], [116.30602473065329, 39.947040442516744], [116.3067607688073, 39.9466545389618], [116.30762000240222, 39.94622107675559], [116.30899238939409, 39.94544261401792], [116.30988742438879, 39.94499145947677], [116.31049604818519, 39.94477030528993], [116.31088986358286, 39.94465530511277], [116.31121207618095, 39.944619920442875], [116.311880368977, 39.94456684343803], [116.31256774523902, 39.94454818428015], [116.31331360777841, 39.94453436214266], [116.31435781533357, 39.9444928957302], [116.31512232443643, 39.94445142931773], [116.31555119539658, 39.94434085221781], [116.31555119539658, 39.9443546743553], [116.31583089384885, 39.94429938580535], [116.31635299762642, 39.944092053743006], [116.3166326960787, 39.94388472168067], [116.31702427391188, 39.94353916824344], [116.31747179143551, 39.94319361480621], [116.31777013645127, 39.942930994193915], [116.31818036084793, 39.94265455144413], [116.31840411960975, 39.94246104151928], [116.31849735242717, 39.94240575296932]]
        const river_array = [[0, 0, 0],
        [2, 2, 0], [7, 8, 0], [10, 18, 0]]
        const river_array2 = [
            [
                23922.0533443857,
                -57096.95589741133
            ],
            [
                23922.0533443857,
                -57153.4504867848
            ],
            [
                23922.0533443857,
                -57225.6375495391
            ],
            [
                23925.29666624032,
                -57322.93232489377
            ],
            [
                23935.026631804183,
                -57395.11815461703
            ],
            [
                23938.26995365694,
                -57454.74953089841
            ],
            [
                23938.26995365694,
                -57504.96514875349
            ],
            [
                23947.999919220805,
                -57533.21132212225
            ],
            [
                23977.189815910533,
                -57589.703427629545
            ],
            [
                23996.64974703826,
                -57643.05678750947
            ],
            [
                23996.64974703826,
                -57646.1952115139
            ],
            [
                23999.89306889288,
                -57708.96348306537
            ],
            [
                24012.866356309503,
                -57809.39189168997
            ],
            [
                24089.185774022713,
                -58034.84155782405
            ],
            [
                24171.535743314773,
                -58224.85403264873
            ],
            [
                24234.881873538718,
                -58420.99212595634
            ],
            [
                24336.235681900755,
                -58684.54658454377
            ],
            [
                24412.251038173214,
                -58892.93352704495
            ],
            [
                24500.935620484874,
                -59015.51203752402
            ],
            [
                24576.950976757333,
                -59138.08903405536
            ],
            [
                24652.966333026066,
                -59236.149541283026
            ],
            [
                24716.312463251874,
                -59328.08038689196
            ],
            [
                24772.31936637126,
                -59412.820631711744
            ],
            [
                24817.155045621097,
                -59486.72334636282
            ],
            [
                24866.972467008978,
                -59586.33048241865
            ],
            [
                24923.026446292177,
                -59694.099546447396
            ],
            [
                24972.324937032536,
                -59761.875273287296
            ],
            [
                25026.812742585316,
                -59859.772728364915
            ],
            [
                25086.489862954244,
                -59947.62859673798
            ],
            [
                25130.59903888218,
                -60017.9127315497
            ],
            [
                25192.87081665732,
                -60103.257083338685
            ],
            [
                25231.79067776911,
                -60166.00981505029
            ],
            [
                25275.89985369146,
                -60246.33273275476
            ],
            [
                25317.41437220946,
                -60319.12481551152
            ],
            [
                25369.307520357892,
                -60429.56695621088
            ],
            [
                25418.606011096388,
                -60522.43780527171
            ],
            [
                25431.579298134893,
                -60572.6379024582
            ],
            [
                25454.931214798242,
                -60622.83774578851
            ],
            [
                25488.879646904767,
                -60725.00116574485
            ],
            [
                25540.742903523147,
                -60841.79032016825
            ],
            [
                25573.901379065588,
                -60913.34355995059
            ],
            [
                25607.910071929917,
                -60965.157653014176
            ],
            [
                25679.13653502427,
                -61057.86353220511
            ],
            [
                25762.165568141267,
                -61165.78760119807
            ],
            [
                25850.383915832266,
                -61273.71049695555
            ],
            [
                25930.81829166785,
                -61376.612630533054
            ],
            [
                25985.30609465204,
                -61454.41597466823
            ],
            [
                26032.009925780818,
                -61514.65040299762
            ],
            [
                26057.956498630345,
                -61547.27723242249
            ],
            [
                26107.25498704426,
                -61605.001360290684
            ],
            [
                26125.417588042095,
                -61640.13762162626
            ],
            [
                26143.580189036205,
                -61680.29319661111
            ],
            [
                26177.310733739287,
                -61738.016551118344
            ],
            [
                26208.446621160954,
                -61800.75894711632
            ],
            [
                26236.938113924116,
                -61902.014220007695
            ],
            [
                26249.9114013426,
                -61999.26316591725
            ],
            [
                26275.857976177707,
                -62077.689041383564
            ],
            [
                26324.507803995162,
                -62221.99103373848
            ],
            [
                26373.157631810755,
                -62328.64768020902
            ],
            [
                26415.06134943664,
                -62414.62523324229
            ],
            [
                26442.045786814764,
                -62460.800531271845
            ],
            [
                26462.803046334535,
                -62496.937571252696
            ],
            [
                26502.24183942564,
                -62551.142884634435
            ],
            [
                26537.529180612415,
                -62589.28718703985
            ],
            [
                26572.816521801054,
                -62627.431342918426
            ],
            [
                26612.255314890295,
                -62683.64351608697
            ],
            [
                26653.769833933562,
                -62761.93851270992
            ],
            [
                26697.360078930855,
                -62840.23289200477
            ],
            [
                26731.8640662916,
                -62919.37471105717
            ],
            [
                26751.323998333886,
                -62972.69943478145
            ],
            [
                26770.783930376172,
                -63035.43403726444
            ],
            [
                26790.243862422183,
                -63123.26181492396
            ],
            [
                26799.97382844612,
                -63211.08881581202
            ],
            [
                26809.703794468194,
                -63283.23184261285
            ],
            [
                26822.677082497627,
                -63345.96448338404
            ],
            [
                26855.110302569345,
                -63436.92610861361
            ],
            [
                26877.813556622714,
                -63502.794351610355
            ],
            [
                26913.490098703653,
                -63574.935259336606
            ],
            [
                26952.40996279195,
                -63615.71032320149
            ],
            [
                26991.329826880246,
                -63653.34869510215
            ],
            [
                27023.76304695569,
                -63690.98692435864
            ],
            [
                27082.142843089998,
                -63728.62501096632
            ],
            [
                27117.8193851728,
                -63769.39944382943
            ],
            [
                27159.98257126659,
                -63828.99254457373
            ],
            [
                27228.548432029784,
                -63956.707592557184
            ],
            [
                27277.84692509286,
                -64047.03634133749
            ],
            [
                27324.550760628656,
                -64144.89155877475
            ],
            [
                27381.633226282895,
                -64240.23674071953
            ],
            [
                27420.553089231253,
                -64345.617192734964
            ],
            [
                27454.28363711387,
                -64413.36117861513
            ],
            [
                27488.01418500021,
                -64456.014562306926
            ],
            [
                27537.31267806515,
                -64508.70378338825
            ],
            [
                27560.66459583305,
                -64538.8117842339
            ],
            [
                27604.773773837835,
                -64571.42868215591
            ],
            [
                27667.04555455409,
                -64606.554452442564
            ],
            [
                27726.722677737474,
                -64626.62626540661
            ],
            [
                27824.377101808786,
                -64643.99573485181
            ],
            [
                27898.973504461348,
                -64669.08539969288
            ],
            [
                28002.759803801775,
                -64728.67309969384
            ],
            [
                28096.8161375802,
                -64813.34974266682
            ],
            [
                28174.65586208552,
                -64894.88953143172
            ],
            [
                28265.468874009326,
                -64985.836967696436
            ],
            [
                28369.25517335348,
                -65086.19179306179
            ],
            [
                28456.8248634208,
                -65180.27352104802
            ],
            [
                28534.664587929845,
                -65246.130200448446
            ],
            [
                28617.762070616707,
                -65317.703231369145
            ],
            [
                28699.697463123128,
                -65373.738089676015
            ],
            [
                28795.346909383312,
                -65436.67829206772
            ],
            [
                28948.12033048831,
                -65549.71275639348
            ],
            [
                29047.75517034158,
                -65615.22077770531
            ],
            [
                29115.506861440837,
                -65647.33239507861
            ],
            [
                29159.34619097598,
                -65664.03039509337
            ],
            [
                29195.214733323082,
                -65669.16823560372
            ],
            [
                29269.60874707997,
                -65676.87499138899
            ],
            [
                29346.127122551203,
                -65679.5842907941
            ],
            [
                29429.156160637736,
                -65681.5912570348
            ],
            [
                29545.396813958883,
                -65687.6121533243
            ],
            [
                29630.501577999443,
                -65693.63304596767
            ],
            [
                29678.243274897337,
                -65709.68874184228
            ],
            [
                29678.243274897337,
                -65707.68178127706
            ],
            [
                29709.37916418165,
                -65715.70962110441
            ],
            [
                29767.499490842223,
                -65745.81396267936
            ],
            [
                29798.635380124673,
                -65775.91821302474
            ],
            [
                29842.225625121966,
                -65826.09176088031
            ],
            [
                29892.04304797016,
                -65876.26505533047
            ],
            [
                29925.254663206637,
                -65914.39658964425
            ],
            [
                29970.92063415423,
                -65954.53488869406
            ],
            [
                29995.829345582053,
                -65982.63160153665
            ],
            [
                30006.207975339144,
                -65990.65921918396
            ]
        ]
        // 河宽 转为经纬度增加值 两点连线 判断轨迹角度 然后计算截面的点 五个点一个面 外管道一截 五个面 10个三角polygon，找出数字规律
        // 朝向 = (X(n+1) - X(n), Y(n+1) - Y(n)) 法向量1 (Y(n+1) - Y(n), X(n) - X(n+1)) 法向量2 (Y(n) - Y(n+1), X(n+1) - X(n))
        // 半河宽w 河深h 河宽收窄比例ratio_w 河深收窄比例ratio_h
        // 第一层: (X(n) + w * Y(n+1) - w * Y(n), Y(n) + w * X(n) - w * X(n+1), 0)  (X(n) + w * Y(n) - w * Y(n+1), Y(n) + w * X(n+1) - w * X(n), 0)
        // 第二层: (X(n) + w * ratio_w * Y(n+1) - w * ratio_w * Y(n), Y(n) + w * ratio_w * X(n) - w * ratio_w * X(n+1), -h)  (X(n) + w * ratio_w * Y(n) - w * ratio_w * Y(n+1), Y(n) + w * ratio_w * X(n+1) - w * ratio_w * X(n), -h)
        // 第三层: (X(n), Y(n), - h - h * ratio_h)
        // (k * 5, k * 5 + 1, k * 5 + 2, k * 5 + 3, k * 5 + 4)
        // 顶面 (k * 5, k * 5 + 1, k * 5 + 5) (k * 5 + 1, k * 5 + 5, k * 5 + 6)
        // 第一层 (k * 5, k * 5 + 2, k * 5 + 5) (k * 5 + 2, k * 5 + 5, k * 5 + 7) (k * 5 + 1, k * 5 + 3, k * 5 + 6) (k * 5 + 3, k * 5 + 6, k * 5 + 8)
        // 第二层 (k * 5 + 2, k * 5 + 4, k * 5 + 7) (k * 5 + 4, k * 5 + 7, k * 5 + 9) (k * 5 + 3, k * 5 + 4, k * 5 + 8) (k * 5 + 4, k * 5 + 8, k * 5 + 9)
        // use Gaode Coordinary translator as the following
        // var customCoords = this.map.customCoords;
        // var data = customCoords.lngLatsToCoords([
        //     [116.048947, 40.395392],
        //     [116.049, 40.395392],
        //     [116.050, 40.395392]
        // ]);
        // 感觉最后这个多边形是投射在圆上的，所以有半径和细节补充之分
        // 这个数据也够生成gltf了，只是想直接threejs原生实现
        const generate_3D_river = function (river_array) {
            const h = 1; //5
            // 一经纬度111公里
            const w = 1; // 15
            const ratio_w = 0.8;
            const ratio_h = 0.3;
            const verticesOfRiver = []
            const river_point_length = river_array.length
            for (var i = 0; i < river_point_length - 1; i++) {
                const Xn = river_array[i][0]
                const Xn1 = river_array[i + 1][0]
                const Yn = river_array[i][1]
                const Yn1 = river_array[i + 1][1]
                verticesOfRiver.push(Xn + w * Yn1 - w * Yn, Yn + w * Xn - w * Xn1, 0, Xn + w * Yn - w * Yn1, Yn + w * Xn1 - w * Xn, 0)
                verticesOfRiver.push(Xn + w * ratio_w * Yn1 - w * ratio_w * Yn, Yn + w * ratio_w * Xn - w * ratio_w * Xn1, -h, Xn + w * ratio_w * Yn - w * ratio_w * Yn1, Yn + w * ratio_w * Xn1 - w * ratio_w * Xn, -h)
                verticesOfRiver.push(Xn, Yn, - h - h * ratio_h)
            }
            const Xn = river_array[river_point_length - 2][0]
            const Xn1 = river_array[river_point_length - 1][0]
            const Yn = river_array[river_point_length - 2][1]
            const Yn1 = river_array[river_point_length - 1][1]
            const Xend = river_array[river_point_length - 1][0];
            const Yend = river_array[river_point_length - 1][1];
            verticesOfRiver.push(Xend + w * Yn1 - w * Yn, Yend + w * Xn - w * Xn1, 0, Xend + w * Yn - w * Yn1, Yend + w * Xn1 - w * Xn, 0)
            verticesOfRiver.push(Xend + w * ratio_w * Yn1 - w * ratio_w * Yn, Yend + w * ratio_w * Xn - w * ratio_w * Xn1, -h, Xend + w * ratio_w * Yn - w * ratio_w * Yn1, Yend + w * ratio_w * Xn1 - w * ratio_w * Xn, -h)
            verticesOfRiver.push(Xend, Yend, - h - h * ratio_h)
            const indicesOfRiverFaces = []
            // 方向应该是朝内还是朝外的区别，比如顺时针朝上，逆时针朝下，左手法则
            for (var k = 0; k < river_point_length - 1; k++) {
                indicesOfRiverFaces.push(k * 5 + 1, k * 5, k * 5 + 5, k * 5 + 5, k * 5 + 6, k * 5 + 1)
                indicesOfRiverFaces.push(k * 5 + 5, k * 5, k * 5 + 2, k * 5 + 2, k * 5 + 7, k * 5 + 5,
                    k * 5 + 3, k * 5 + 1, k * 5 + 6, k * 5 + 6, k * 5 + 8, k * 5 + 3)
                indicesOfRiverFaces.push(k * 5 + 7, k * 5 + 2, k * 5 + 4, k * 5 + 4, k * 5 + 9, k * 5 + 7,
                    k * 5 + 4, k * 5 + 3, k * 5 + 8, k * 5 + 8, k * 5 + 9, k * 5 + 4)
            }
            return { verticesOfRiver, indicesOfRiverFaces }
        }
        const res = generate_3D_river(river_array)
        console.log(res)
        const verticesOfCube = [
            -1, -1, -1, 1, -1, -1, 1, 1, -1, -1, 1, -1,
            -1, -1, 1, 1, -1, 1, 1, 1, 1, -1, 1, 1,
        ];

        // 同一个屏幕要首尾相接
        const indicesOfFaces = [
            2, 1, 0, 0, 3, 2,
            0, 4, 7, 7, 3, 0,
            0, 1, 5, 5, 4, 0,
            1, 2, 6, 6, 5, 1,
            2, 3, 7, 7, 6, 2,
            4, 5, 6, 6, 7, 4
        ];

        // const geometry = new THREE.PolyhedronGeometry(verticesOfCube, indicesOfFaces,);
        const geometry = new THREE.PolyhedronGeometry(res.verticesOfRiver, res.indicesOfRiverFaces);
        const material = new THREE.MeshToonMaterial({ color: 0x049ef4 });
        // new THREE.Color().setHSL(0.1, 0.5, 0.1 * 0.1 + 0.1).multiplyScalar(1 - 0.1 * 0.2)
        // const material = new THREE.MeshToonMaterial({ color: 0x049ef4 });
        const light = new THREE.AmbientLight(0x888888);
        scene.add(light);
        // scene.add(new THREE.AmbientLight());
        console.log(material.color);
        // const frog = new THREE.Frog({ color: 0x3f7b9d })
        const cube = new THREE.Mesh(geometry, material);
        // scene.add(frog)
        scene.add(cube);

        // camera.position.z = 5;
        //create a blue LineBasicMaterial
        const material2 = new THREE.LineBasicMaterial({ color: 0x0000ff });
        const points = [];
        // points.push(new THREE.Vector3(- 10, 0, 0));
        points.push(new THREE.Vector3(23922, -57096, 0));
        // points.push(new THREE.Vector3(0, 10, 0));
        points.push(new THREE.Vector3(24652, -59236, 0));
        points.push(new THREE.Vector3(10, 0, 0));

        const geometry2 = new THREE.BufferGeometry().setFromPoints(points);
        const line = new THREE.Line(geometry2, material2);
        scene.add(line);

        // renderer.render(scene, camera);
        function animate() {
            requestAnimationFrame(animate);
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>

</html>